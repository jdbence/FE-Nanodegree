"use strict";var El=function(){var e=function(){};return e.removeClass=function(e,t){var i,n;if(e)for(this.isHTMLCollection(e)||(e=[e]),i=0;i<e.length;i++)n=e[i].className.replace(" "+t,""),e[i].className=n},e.addClass=function(e,t){var i;if(e)for(this.isHTMLCollection(e)||(e=[e]),i=0;i<e.length;i++)e[i].className.indexOf(" "+t)<0&&(e[i].className+=" "+t)},e.addListener=function(e,t,i){var n;if(e)for(void 0===e.length&&(e=[e]),n=0;n<e.length;n++)e[n].addEventListener(t,i)},e.show=function(e){this.removeClass(this.getElements(e),"hidden")},e.hide=function(e){this.addClass(this.getElements(e),"hidden")},e.getElements=function(e){return this.isString(e)?-1!==e.indexOf("#")?document.getElementById(e):document.getElementsByClassName(e):null},e.isString=function(e){return this.isType(e,"[object String]")},e.isHTMLCollection=function(e){return this.isType(e,"[object HTMLCollection]")},e.isType=function(e,t){return Object.prototype.toString.call(e)===t},e}(),Entity=function(e,t,i,n,r){this.x=e,this.y=t,this.sprite=i||null,this.offsetX=n||0,this.offsetY=r||0,this.flipped=!1,this.alpha=1,this.isAlive=!0,this.speed=0,this.angle=0,this.components=[],this.type=""};(function(){this.addComponent=function(e){return-1===this.components.indexOf(e)&&(e.owner=this,this.components.push(e)),e},this.update=function(e){var t,i=this.components.length;for(t=0;i>t;t++)this.components[t].update(e)},this.render=function(e){var t,i=this.components.length;for(t=0;i>t;t++)this.components[t].render(e)}}).call(Entity.prototype),function(){function e(){var e=!0;for(var t in s)s.hasOwnProperty(t)&&!s[t]&&(e=!1);return e}function t(t){if(s[t])return s[t];var i=new Image;i.onload=function(){s[t]=i,e()&&o.forEach(function(e){e()})},s[t]=!1,i.src=t}function i(e){e instanceof Array?e.forEach(function(e){t(e)}):t(e)}function n(e){return s[e]}function r(e){o.push(e)}var s={},o=[];window.Resources={load:i,get:n,onReady:r,isReady:e}}();var Collision=function(){var e=function(){};return e.isColliding=function(e,t){return e.x<t.x+t.width&&e.x+t.width>t.x&&e.y<t.y+t.height&&e.height+e.y>t.y},e}(),Engine=function(e){function t(e){p.entities.forEach(function(t){t.update(e)}),player.update(e)}function i(e){t(e)}function n(){var e;for(e=0;e<p.entities.length;e++)p.entities[e].render(d);player.render(d)}function r(){var e,t,i=["images/water-block.png","images/stone-block.png","images/stone-block.png","images/stone-block.png","images/grass-block.png","images/grass-block.png"],r=6,s=5;for(d.clearRect(0,0,c.width,c.height),e=0;r>e;e++)for(t=0;s>t;t++)d.drawImage(Resources.get(i[e]),101*t,83*e);n()}function s(){if(u){var e=Date.now(),t=(e-a)/1e3;i(t),r(),a=e,h.requestAnimationFrame(s)}}function o(){p.reset(),u=!0,a=Date.now(),s()}var a,l=e.document,h=e.window,c=l.createElement("canvas"),d=c.getContext("2d"),u=!1,p=function(){};return p.entities=[],p.width=c.width=505,p.height=c.height=606,c.className+=" canvas-game",l.getElementsByClassName("level")[0].appendChild(c),p.reset=function(){u=!1},p.pause=function(){u=!1},p.preload=function(){function e(e,t){var i=["char-boy","char-cat-girl","char-horn-girl","char-pink-girl","char-princess-girl","enemy-bug","Gem Blue","Gem Green","Gem Orange","grass-block","Heart","Key","Rock","Selector","Star","stone-block","water-block"];return i.map(function(i){return e+i+"."+t})}Resources.load(e("images/","png")),Resources.isReady()?o():Resources.onReady(o)},e.ctx=d,p}(this),Model=function(){var e={},t=function(){};return t.set=function(t,i){return e[t]=i,i},t.get=function(t){return e[t]},t}(),Timer=function(e,t){this.intervals=e,this.delay=t,this.running=!1,this.listeners={},this.time=0,this.laps=0};(function(){this.start=function(){this.running=!0,this.time=this.delay,this.laps=this.intervals},this.update=function(e){this.running&&(this.time=Math.max(0,this.time-e),0===this.time&&(this.laps-=1,this.laps<=0?(this.running=!1,this.dispatch("COMPLETE")):(this.time=this.delay,this.dispatch("UPDATE"))))},this.on=function(e,t){this.listeners.hasOwnProperty(e)||(this.listeners[e]=[]),this.listeners[e].push(t)},this.dispatch=function(e){var t,i;if(this.listeners.hasOwnProperty(e))for(i=this.listeners[e],t=0;t<i.length;t++)i[t](this)}}).call(Timer.prototype);var Grid=function(){var e=function(){};return e.cellWidth=101,e.cellHeight=83,e.columns=5,e.rows=6,e.offsetY=50,e.getXFromColumn=function(t){var i=Math.max(0,Math.min(t,e.columns-1));return i*e.cellWidth},e.getYFromRow=function(t){return t=Math.max(0,Math.min(t,e.rows-1)),e.offsetY+t*e.cellHeight},e}(),Level=function(){this.reset()};(function(){this.reset=function(){this.level=Model.set("level",0),this.lastLevel=7,Model.set("level_total_time",15),Model.set("level_complete",!1)},this.next=function(){this.level=Model.set("level",this.level+1)},this.addEntities=function(){var e,t=this.levelData();for(Engine.entities=[],e=0;e<t.length;e++)t[e].hasOwnProperty("t")?Blueprint.create(t[e].t,t[e]):Blueprint.create("enemy",t[e])},this.levelData=function(){return 0===this.level?[{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:1===this.level?[{r:3,c:0,s:200},{r:3,c:2,s:200},{r:3,c:4,s:200},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:2===this.level?[{r:1,c:0,s:-100},{r:1,c:1,s:-100},{r:1,c:3,s:-100},{r:1,c:4,s:-100},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:3===this.level?[{r:2,c:0,s:500},{r:2,c:4,s:600},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:4===this.level?[{r:1,c:0,s:-100},{r:1,c:1,s:-100},{r:1,c:3,s:-100},{r:1,c:4,s:-100},{r:3,c:0,s:200},{r:3,c:2,s:200},{r:3,c:4,s:200},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:5===this.level?[{r:2,c:0,s:500},{r:2,c:4,s:600},{r:3,c:0,s:200},{r:3,c:2,s:200},{r:3,c:4,s:200},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:6===this.level?[{r:1,c:0,s:-100},{r:1,c:1,s:-100},{r:1,c:3,s:-100},{r:1,c:4,s:-100},{r:2,c:0,s:500},{r:2,c:4,s:600},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]:[{r:1,c:0,s:-100},{r:1,c:1,s:-100},{r:1,c:3,s:-100},{r:1,c:4,s:-100},{r:2,c:0,s:500},{r:2,c:4,s:600},{r:3,c:0,s:200},{r:3,c:2,s:200},{r:3,c:4,s:200},{r:0,c:0,t:"water"},{r:0,c:1,t:"water"},{r:0,c:2,t:"key"},{r:0,c:3,t:"water"},{r:0,c:4,t:"water"}]}}).call(Level.prototype);var Scene=function(){var e,t=function(){},i=new Level,n=function(e){var t=e.target.src;player.sprite=t.slice(t.indexOf("/images/")+1,t.length),El.removeClass(El.getElements("selected-char"),"selected-char"),El.addClass(e.target,"selected-char")};return t.startMenu=function(){var e,t=El.getElements("char");for(e=0;e<t.length;e++)t[e].addEventListener("click",n);Engine.reset(),El.show("char_select"),El.hide("level"),El.hide("gameover"),El.hide("gamewin"),scene="char_select"},t.startGame=function(e){e=e||!1,player.respawn(!1),e?i.reset():Model.set("level_complete",!1),Engine.preload(),i.addEntities(),Engine.entities.push(ui),ui.start(),El.show("level"),El.hide("char_select"),El.hide("gameover"),El.hide("gamewin"),scene="level"},t.endGame=function(){El.show("gameover"),Engine.pause()},t.winGame=function(){El.show("gamewin"),Engine.pause()},t.levelComplete=function(){Model.set("level_complete",!0),Engine.entities.push(new Explosion(0,2)),clearTimeout(e),e=setTimeout(t.nextLevel,1500)},t.nextLevel=function(){i.next(),i.level>i.lastLevel?t.winGame():t.startGame()},t}(),Sensor=function(e,t,i,n,r,s){this.x=e,this.y=t,this.width=i,this.height=n,this.offsetX=r,this.offsetY=s,this.debug=!1,this.owner=null};(function(){this.render=function(e){this.debug&&(e.beginPath(),e.strokeStyle="red",e.rect(this.x,this.y,this.width,this.height),e.stroke())},this.update=function(e){if(this.owner){this.position(this.owner.x,this.owner.y);var t=this.owner.target;t&&t.isAlive&&!Model.get("level_complete")&&Collision.isColliding(this,t.sensor)&&t.hit(this.owner.type)}},this.position=function(e,t){this.x=e+this.offsetX,this.y=t+this.offsetY}}).call(Sensor.prototype);var Render=function(){};(function(){var e={x:0,y:0};this.render=function(e){var t=this.owner.flipped?-1:1,i=this.getPosition();e.save(),e.scale(t,1),e.globalAlpha=this.owner.alpha||1,e.drawImage(Resources.get(this.owner.sprite),i.x,i.y,101,171),e.restore()},this.update=function(e){},this.getPosition=function(){var t=this.owner.flipped?-1:1;return e.x=(this.owner.x+this.owner.offsetX)*t,e.x+=1===t?0:-101,e.y=this.owner.y+this.owner.offsetY,e}}).call(Render.prototype);var KeyboardInput=function(){var e=this,t=function(t){e.handleInput(t)},i={x:0,y:0},n={x:0,y:0},r=function(e,t,i,n){return Math.sqrt((e-t)*(e-t)+(i-n)*(i-n))};document.addEventListener("keyup",t),document.addEventListener("touchstart",function(e){i.x=e.changedTouches[0].pageX,i.y=e.changedTouches[0].pageY}),document.addEventListener("touchend",function(t){n.x=t.changedTouches[0].pageX,n.y=t.changedTouches[0].pageY;var s=180*Math.atan2(n.y-i.y,n.x-i.x)/Math.PI+180,o=r(i.x,n.x,i.y,n.y);o>5?s>=45&&135>=s?e.handleInput({keyCode:38}):s>=135&&225>=s?e.handleInput({keyCode:39}):s>=225&&315>=s?e.handleInput({keyCode:40}):e.handleInput({keyCode:37}):e.handleInput({keyCode:38})})};(function(){var e={37:"left",38:"up",39:"right",40:"down"},t={left:{axis:"x",dir:-1},up:{axis:"y",dir:-1},right:{axis:"x",dir:1},down:{axis:"y",dir:1}};this.getMovement=function(e,t){var i;return"x"===e?(i=Math.floor(this.owner.x/Grid.cellWidth)+t,Grid.getXFromColumn(i)):(i=Math.floor(this.owner.y/Grid.cellHeight)+t,Grid.getYFromRow(i))},this.handleInput=function(i){var n=e[i.keyCode];if(n&&this.owner.isAlive===!0&&!Model.get("level_complete")){var r=t[n];r.hasOwnProperty("axis")&&(this.owner[r.axis]=this.getMovement(r.axis,r.dir))}},this.update=function(e){},this.render=function(e){}}).call(KeyboardInput.prototype);var Movement=function(){this.wrap=!1};(function(){this.update=function(e){this.owner.x+=this.owner.speed*Math.cos(this.owner.angle)*e,this.owner.y+=this.owner.speed*Math.sin(this.owner.angle)*e,this.wrap&&(this.owner.x>Grid.columns*Grid.cellWidth+Grid.cellWidth?this.owner.x=Grid.getXFromColumn(0)-Grid.cellWidth:this.owner.x<-Grid.cellWidth&&(this.owner.x=Grid.columns*Grid.cellWidth+Grid.cellWidth))},this.render=function(e){}}).call(Movement.prototype);var Blueprint=function(){var e={},t=function(){};return t.create=function(t,i){var n=null;return e.hasOwnProperty(t)&&(n=e[t](i),n.type=t,Engine.entities.push(n)),n},e.key=function(e){var t=Grid.getXFromColumn(e.c),i=Grid.getYFromRow(e.r),n=new Entity(t,i,"images/Key.png",0,-33-Grid.offsetY);return n.addComponent(new Render),n.addComponent(new Sensor(0,0,50,50,25,12)),n.target=player,n},e.star=function(e){var t=Grid.getXFromColumn(e.c),i=Grid.getYFromRow(e.r),n=new Entity(t,i,"images/Star.png",0,-33-Grid.offsetY);n.addComponent(new Render),n.addComponent(new Movement),n.speed=400,n.angle=Math.round(180*Math.random())*Math.PI/180;var r=n.update;return n.update=function(e){r.apply(this,arguments),n.alpha=Math.max(.01,n.alpha-1*e)},n},e.water=function(e){var t=Grid.getXFromColumn(e.c),i=Grid.getYFromRow(e.r),n=new Entity(t,i,"",0,-33-Grid.offsetY);return n.addComponent(new Sensor(0,0,50,50,25,12)),n.target=player,n},e.enemy=function(e){var t=Grid.getXFromColumn(e.c),i=Grid.getYFromRow(e.r),n=new Entity(t,i,"images/enemy-bug.png",0,-33-Grid.offsetY);return n.addComponent(new Render),n.addComponent(new Movement).wrap=!0,n.addComponent(new Sensor(0,0,50,50,25,12)),n.row=e.r,n.speed=e.s,n.flipped=n.speed<0,n.target=player,n},e.player=function(e){var t=Grid.getXFromColumn(e.c),i=Grid.getYFromRow(e.r),n=new Entity(t,i,"images/char-boy.png",0,-33-Grid.offsetY);n.addComponent(new Render),n.sensor=n.addComponent(new Sensor(0,0,50,50,25,12)),n.addComponent(new KeyboardInput),n.blinkTimer=new Timer(5,.2);var r=function(){n.alpha=1,n.isAlive=!0},s=function(){n.alpha=.4===n.alpha?1:.4};n.blinkTimer.on("COMPLETE",r),n.blinkTimer.on("UPDATE",s);var o=n.update;return n.update=function(e){o.apply(this,arguments),n.blinkTimer.update(e)},n.respawn=function(e){this.x=n.sensor.x=Grid.getXFromColumn(2),this.y=n.sensor.y=Grid.getYFromRow(5),this.isAlive=e,this.isAlive||(n.alpha=.4,n.blinkTimer.start())},n.hit=function(e){"water"===e||"enemy"===e?this.respawn(!1):"key"===e&&Scene.levelComplete()},n},t}(),UI=function(){this.keys=0,this.levelTime=0,this.time=0};(function(){this.start=function(){this.keys=Model.get("level"),this.levelTime=Model.get("level_total_time"),this.levelTimer=new Timer(1,this.levelTime),this.levelTimer.on("COMPLETE",this.onTimerComplete),this.levelTimer.start()},this.onTimerComplete=function(){Model.get("level_complete")||Scene.endGame()},this.formattedTime=function(){var e=Math.round(this.levelTimer.time);return"00:"+(e>9?e:"0"+e)},this.text=function(e,t,i,n,r){e.save(),e.font="30px Comic Sans MS",("left"===r||"right"===r||"center"===r)&&(e.textAlign=r),e.fillText(t,i,n),e.restore()},this.update=function(e){Model.get("level_complete")||(this.keys=Model.get("level"),this.levelTimer.update(e))},this.render=function(e){this.text(e,"Keys: x"+this.keys,0,30),this.text(e,"Time: "+this.formattedTime(),Engine.width,30,"right")}}).call(UI.prototype);var Key=function(e,t){this.entity=new Entity(this,Grid.getXFromColumn(t),Grid.getYFromRow(e),"images/Key.png",0,-33-Grid.offsetY),this.sensor=new Sensor(0,0,50,30,25,25),this.renderer=new Render(this)};(function(){this.update=function(e){this.sensor.position(this.x,this.y),player&&player.isAlive&&this.isAlive&&Collision.isColliding(this.sensor,player.sensor)&&(this.isAlive=!1,player.hit("key"))},this.render=function(e){this.renderer.render(e),this.sensor.render(e)}}).call(Key.prototype);var Water=function(e,t){this.entity=new Entity(this,Grid.getXFromColumn(t),Grid.getYFromRow(e),"images/Key.png",0,-33-Grid.offsetY),this.sensor=new Sensor(0,0,50,30,25,25)};(function(){this.update=function(e){this.sensor.position(this.x,this.y),player&&player.isAlive&&Collision.isColliding(this.sensor,player.sensor)&&player.hit("water")},this.render=function(e){this.sensor.render(e)}}).call(Water.prototype);var Enemy=function(e,t,i){this.entity=new Entity(this,Grid.getXFromColumn(t),Grid.getYFromRow(e),"images/enemy-bug.png",0,-33-Grid.offsetY),this.row=e,this.speed=i,this.flipped=0>i,this.sensor=new Sensor(0,0,50,50,25,12),this.renderer=new Render(this)};(function(){this.update=function(e){this.x+=e*this.speed,this.x>Grid.columns*Grid.cellWidth+Grid.cellWidth?this.x=Grid.getXFromColumn(0)-Grid.cellWidth:this.x<-Grid.cellWidth&&(this.x=Grid.columns*Grid.cellWidth+Grid.cellWidth),this.sensor.position(this.x,this.y),player&&player.isAlive&&Collision.isColliding(this.sensor,player.sensor)&&player.hit("enemy")},this.render=function(e){this.renderer.render(e),this.sensor.render(e)}}).call(Enemy.prototype);var Player=function(){this.entity=new Entity(this,0,0,"images/char-boy.png",0,-33-Grid.offsetY),this.isAlive=!1,this.alpha=0,this.sensor=new Sensor(0,0,50,30,25,25),this.renderer=new Render(this),this.blinkTimer=new Timer(5,.2);var e=this,t=function(){e.alpha=1,e.isAlive=!0},i=function(){e.alpha=.4===e.alpha?1:.4},n=function(t){e.handleInput(t)};this.blinkTimer.on("COMPLETE",t),this.blinkTimer.on("UPDATE",i),document.addEventListener("keyup",n),this.respawn()};(function(){var e={37:"left",38:"up",39:"right",40:"down"},t={left:{axis:"x",dir:-1},up:{axis:"y",dir:-1},right:{axis:"x",dir:1},down:{axis:"y",dir:1}};this.respawn=function(){this.sensor.x=this.x=Grid.getXFromColumn(2),this.sensor.y=this.y=Grid.getYFromRow(5),this.isAlive=!1,this.alpha=.4,this.blinkTimer.start()},this.hit=function(e){"water"===e||"enemy"===e?this.respawn():"key"===e&&Scene.levelComplete()},this.getMovement=function(e,t){var i;return"x"===e?(i=Math.floor(this.x/Grid.cellWidth)+t,Grid.getXFromColumn(i)):(i=Math.floor(this.y/Grid.cellHeight)+t,Grid.getYFromRow(i))},this.handleInput=function(i){var n=e[i.keyCode];if(n&&this.isAlive===!0&&!Model.get("level_complete")){var r=t[n];r.hasOwnProperty("axis")&&(this[r.axis]=this.getMovement(r.axis,r.dir))}},this.update=function(e){this.sensor.position(this.x,this.y),this.isAlive||this.blinkTimer.update(e)},this.render=function(e){this.renderer.render(e),this.sensor.render(e)}}).call(Player.prototype);var Star=function(e,t){this.entity=new Entity(this,Grid.getXFromColumn(t),Grid.getYFromRow(e),"images/Star.png",0,-33-Grid.offsetY),this.renderer=new Render(this),this.speed=500,this.angle=Math.round(180*Math.random())*Math.PI/180};(function(){this.update=function(e){this.x+=this.speed*Math.cos(this.angle)*e,this.y+=this.speed*Math.sin(this.angle)*e,this.alpha=Math.max(.01,this.alpha-1*e)},this.render=function(e){this.renderer.render(e)}}).call(Star.prototype);var Explosion=function(e,t){this.stars=[],this.addStars(e,t,10)};(function(){this.addStars=function(e,t,i){var n,r={r:e,c:t};for(n=0;i>n;n++)this.stars.push(Blueprint.create("star",r))},this.update=function(e){var t,i=this.stars.length;if(i>0)if(this.stars[0].alpha<=.01)this.stars=[];else for(t=0;i>t;t++)this.stars[t].update(e)},this.render=function(e){var t,i=this.stars.length;for(t=0;i>t;t++)this.stars[t].render(e)}}).call(Explosion.prototype);var player=Blueprint.create("player",{r:5,c:2}),ui=new UI,scene="",App=function(){var e=function(){Scene.startGame(!0)},t=function(){Scene.startGame()},i=function(){Scene.startMenu()};El.addListener(El.getElements("btn-play")[0],"click",e),El.addListener(El.getElements("btn-replay")[0],"click",t),El.addListener(El.getElements("btn-menu"),"click",i),Scene.startMenu()}();